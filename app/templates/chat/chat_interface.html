{% extends "base.html" %}
{% import "_form_helpers.html" as forms %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    #chat-messages-container {
        height: calc(100vh - 300px); /* Adjust based on your header/footer/input height */
        overflow-y: auto;
    }
    .chat-message {
        opacity: 0;
        transform: translateY(20px);
        animation: slideInUp 0.3s forwards;
    }
    @keyframes slideInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    /* For typing indicator */
    .typing-indicator span {
        height: 8px;
        width: 8px;
        float: left; /* DaisyUI chat bubble content is flex, float might not be ideal but let's keep for now
        margin: 0 1px;
        background-color: hsl(var(--ac)); /* Use DaisyUI accent-content color */
        display: block;
        border-radius: 50%;
        opacity: 1; /* Full opacity */
        animation: typingAnimation 1s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typingAnimation {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1.0); }
    }

    /* Drawer specific styles */
    .drawer-side > *:not(label) {
        max-width: 90vw; /* Sensible max-width for drawer on small screens */
    }
    @media (min-width: 640px) { /* sm breakpoint or adjust as needed */
      .drawer-side > *:not(label) {
        max-width: 420px; /* Max width for larger screens */
      }
    }
    
    /* å¤šæ¨¡å‹å“åº”æ ·å¼ */
    .model-response-container {
        margin-top: 0.75rem;
        margin-bottom: 0.75rem;
    }
    .model-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
    }
    .model-name-badge {
        font-size: 0.75rem;
        padding: 0.125rem 0.375rem;
        border-radius: 0.5rem;
        margin-right: 0.375rem;
    }

    /* æ¨ç†æ¨¡å‹æ€è€ƒè¿‡ç¨‹æ ·å¼ */
    .thinking-container {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        position: relative;
    }
    .thinking-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
    }
    .thinking-content {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.875rem;
        line-height: 1.5;
        color: #4b5563;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .thinking-toggle {
        cursor: pointer;
        user-select: none;
    }
    .thinking-content.collapsed {
        display: none;
    }
    .answer-content {
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="drawer drawer-end" style="height: calc(100vh - 64px - 5rem);"> {# Adjust height based on navbar and footer approx heights #}
    <input id="model-config-drawer-toggle" type="checkbox" class="drawer-toggle" />
    
    {# Drawer Content (Main Chat Interface) #}
    <div class="drawer-content flex flex-col">
        <div class="flex flex-col h-full max-w-8xl mx-auto w-full">
            {# Header for title and drawer toggle button #}
            <div class="p-4 border-b border-base-300 flex justify-between items-center">
                <h1 class="text-xl font-semibold">{{ title }}</h1>
                <div class="flex items-center space-x-2">
                    <button id="new-chat-with-config-btn" class="btn btn-success btn-sm">
                        <i class="fas fa-plus mr-1"></i> æ–°å¯¹è¯
                    </button>
                    <label for="model-config-drawer-toggle" class="btn btn-primary btn-sm drawer-button">
                        <i class="fas fa-cogs mr-1"></i> æ¨¡å‹é…ç½®
                    </label>
                </div>
            </div>

            {# Chat messages container #}
            <div id="chat-messages-container" 
                 class="flex-grow p-4 space-y-4 bg-base-100 rounded-b-lg overflow-y-auto"
                 data-session-id="{{ session.id }}"
                 data-is-model-preselected="{{ true if (current_model and current_model.id) else false }}"
                 data-has-saved-configs="{{ true if saved_configs else false }}">
                
                {% for message in messages %}
                    <div class="chat-message chat {% if message.role == 'user' %}chat-end{% else %}chat-start{% endif %}" data-message-id="{{ message.id }}">
                        <div class="chat-header pb-1">
                            {{ message.role | capitalize }}
                            <time class="text-xs opacity-50 ml-1">{{ message.timestamp.strftime('%H:%M') }}</time>
                            {% if message.role == 'assistant' and message.model_id %}
                                <span class="text-xs opacity-60 ml-1"> ({{ message.model.display_name }})</span>
                            {% endif %}
                        </div>
                        <div class="chat-bubble {% if message.role == 'user' %}chat-bubble-primary{% elif message.role == 'assistant' %}chat-bubble-accent{% else %}chat-bubble-info{% endif %}">
                            {{ message.content }}
                        </div>
                    </div>
                {% else %}
                    <div id="empty-chat-placeholder" class="text-center text-gray-500 pt-10">
                        <p class="text-lg">å¯¹è¯ä»è¿™é‡Œå¼€å§‹ã€‚</p>
                        <p>é€‰æ‹©ä¸€ä¸ªæ¨¡å‹å¹¶å‘é€æ‚¨çš„ç¬¬ä¸€æ¡æ¶ˆæ¯å§ï¼</p>
                    </div>
                {% endfor %}
                <div id="typing-indicator-container" class="chat chat-start" style="display: none;">
                    <div class="chat-header pb-1">Assistant <span class="text-xs opacity-60 ml-1" id="typing-indicator-model-name"></span></div>
                    <div class="chat-bubble chat-bubble-accent">
                        <div class="typing-indicator"><span></span><span></span><span></span></div>
                    </div>
                </div>
            </div>

            {# Chat input form #}
            <div class="p-4 border-t border-base-300 bg-base-200">
                <form id="chat-form" class="flex items-center space-x-2">
                    <textarea id="message-input" class="textarea textarea-bordered flex-grow resize-none" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." rows="1"></textarea>
                    <button type="submit" id="send-button" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i><span class="ml-2">å‘é€</span> 
                    </button>
                </form>
            </div>
        </div>
    </div> 

    {# Drawer Side (Model Configuration Panels) #}
    <div class="drawer-side overflow-y-auto">
        <label for="model-config-drawer-toggle" aria-label="close sidebar" class="drawer-overlay"></label>
        <div class="p-4 w-full bg-base-200 text-base-content flex flex-col space-y-4 h-full">
            <div class="flex justify-between items-center w-full mb-2">
                <h2 class="text-lg font-semibold">æ¨¡å‹é…ç½®</h2>
                <button id="add-model-panel-btn" class="btn btn-sm btn-outline btn-primary">
                    <i class="fas fa-plus mr-1"></i> æ·»åŠ æ¨¡å‹ (1/3)
                </button>
            </div>

            <div id="model-config-panels-container" class="space-y-6 w-full flex-grow overflow-y-auto pr-1">
                {# Model config panel template is now primarily for JS #}
                <div class="model-config-panel p-4 border rounded-lg shadow bg-base-100" data-panel-id="1">
                    <div class="flex justify-between items-center mb-3">
                        <select class="model-selector select select-bordered select-sm w-full max-w-xs" data-panel-id="1">
                            <option disabled selected>è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹...</option>
                            {% for model in available_models %}
                                <option value="{{ model.id }}"
                                        data-sysprompt="{{ model.system_prompt | default('You are a helpful assistant.', true) | e }}"
                                        data-temp="{{ model.default_temperature | default(0.7, true) }}">
                                    {{ model.display_name }} {% if model.is_system_model %}(ç³»ç»Ÿ){% else %}(è‡ªå®šä¹‰){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="flex items-center space-x-1 ml-1 flex-shrink-0">
                            <button class="btn btn-xs btn-ghost toggle-config-btn" data-panel-id="1" aria-expanded="false">
                                <i class="fas fa-sliders-h"></i>
                            </button>
                            <button class="btn btn-xs btn-ghost text-error remove-model-btn" data-panel-id="1" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="model-parameters p-3 border-t border-base-200" style="display: none;">
                        <div class="form-control mb-3">
                            <label class="label">
                                <span class="label-text">System Prompt</span>
                            </label>
                            <textarea class="system-prompt-input textarea textarea-bordered textarea-sm h-20" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„åŠ©æ‰‹ã€‚"></textarea>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Temperature</span>
                                <span class="temperature-value-display text-sm">0.7</span>
                            </label>
                            <input type="range" min="0" max="1" step="0.1" value="0.7" class="temperature-slider range range-xs range-primary" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }} {# Includes base modal and other scripts #}
<script>
document.addEventListener('DOMContentLoaded', function () {
    marked.setOptions({ gfm: true, breaks: true }); // MODIFIED

    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('chat-messages-container');
    const sendButton = document.getElementById('send-button');
    const emptyChatPlaceholder = document.getElementById('empty-chat-placeholder');
    const typingIndicatorContainer = document.getElementById('typing-indicator-container');
    const typingIndicatorModelName = document.getElementById('typing-indicator-model-name');

    // --- å¤šæ¨¡å‹UIæ§åˆ¶ --- 
    const modelPanelsContainer = document.getElementById('model-config-panels-container');
    const addModelBtn = document.getElementById('add-model-panel-btn');
    const MAX_MODELS = 3;
    let modelPanelCount = 0; 
    const sessionId = messagesContainer.dataset.sessionId;
    const isModelPreselected = messagesContainer.dataset.isModelPreselected === 'true'; 
    const hasSavedConfigs = messagesContainer.dataset.hasSavedConfigs === 'true';
    let assistantRawMarkdownHolder = ''; 
    let currentAssistantMessageBubble = null; 
    let currentModelNameForTyping = null;

    // NEW: Process initially rendered messages by Jinja2
    const initialMessageBubbles = messagesContainer.querySelectorAll('.chat-message .chat-bubble:not(#typing-indicator-container .chat-bubble)');
    initialMessageBubbles.forEach(bubble => {
        const rawMarkdown = bubble.innerHTML;
        
        // è§£ç HTMLå®ä½“
        function decodeHtmlEntities(text) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }
        
        const decodedMarkdown = decodeHtmlEntities(rawMarkdown);
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ¨ç†æ ¼å¼ <think>xxx</think><answer>xxx</answer>
        // å¤„ç†å¯èƒ½çš„åŒé‡thinkæ ‡ç­¾: <think><think>content</think>
        let thinkAnswerRegex = /<think.*?>([\s\S]*?)<\/think><answer>([\s\S]*?)<\/answer>/;
        let match = decodedMarkdown.match(thinkAnswerRegex);
        
        // å¦‚æœç¬¬ä¸€ä¸ªæ­£åˆ™ä¸åŒ¹é…ï¼Œå°è¯•ç¬¬äºŒä¸ª
        if (!match) {
            thinkAnswerRegex = /<think>([\s\S]*?)<\/think><answer>([\s\S]*?)<\/answer>/;
            match = decodedMarkdown.match(thinkAnswerRegex);
        }
        
        console.log('æ¨ç†å†…å®¹åŒ¹é…ç»“æœ:', match);
        console.log('è§£ç åå†…å®¹å‰200å­—ç¬¦:', decodedMarkdown.substring(0, 200));
        console.log('æ˜¯å¦åŒ…å«<think>:', decodedMarkdown.includes('<think>'));
        console.log('æ˜¯å¦åŒ…å«</think>:', decodedMarkdown.includes('</think>'));
        console.log('æ˜¯å¦åŒ…å«<answer>:', decodedMarkdown.includes('<answer>'));
        console.log('æ˜¯å¦åŒ…å«</answer>:', decodedMarkdown.includes('</answer>'));
        
        if (match && match[1] && match[2]) {
            // æœ‰æ¨ç†å†…å®¹ï¼Œåˆ›å»ºç‰¹æ®Šå¸ƒå±€
            const thinkingText = match[1].trim();
            const answerText = match[2].trim();
            
            // æ¸…ç©ºæ°”æ³¡å†…å®¹
            bubble.innerHTML = '';
            
            // åˆ›å»ºæ€è€ƒè¿‡ç¨‹å®¹å™¨
            const thinkingContainer = document.createElement('div');
            thinkingContainer.classList.add('thinking-container');
            
            const thinkingHeader = document.createElement('div');
            thinkingHeader.classList.add('thinking-header', 'thinking-toggle');
            thinkingHeader.innerHTML = '<i class="fas fa-brain mr-2"></i>ğŸ’­ æ€è€ƒè¿‡ç¨‹ <i class="fas fa-chevron-down ml-auto"></i>';
            
            const thinkingContent = document.createElement('div');
            thinkingContent.classList.add('thinking-content', 'collapsed');
            thinkingContent.textContent = thinkingText;
            
            thinkingContainer.appendChild(thinkingHeader);
            thinkingContainer.appendChild(thinkingContent);
            
            // æ·»åŠ ç‚¹å‡»æŠ˜å åŠŸèƒ½
            thinkingHeader.addEventListener('click', () => {
                const isCollapsed = thinkingContent.classList.contains('collapsed');
                // æ›´å¥å£®çš„å›¾æ ‡æŸ¥æ‰¾ï¼šæŸ¥æ‰¾æœ€åä¸€ä¸ª i å…ƒç´ ï¼ˆchevronå›¾æ ‡ï¼‰
                const chevron = thinkingHeader.querySelector('i:last-child');
                if (isCollapsed) {
                    thinkingContent.classList.remove('collapsed');
                    chevron.className = 'fas fa-chevron-up ml-auto';
                } else {
                    thinkingContent.classList.add('collapsed');
                    chevron.className = 'fas fa-chevron-down ml-auto';
                }
            });
            
            // åˆ›å»ºç­”æ¡ˆå®¹å™¨
            const answerContainer = document.createElement('div');
            answerContainer.classList.add('answer-content');
            answerContainer.innerHTML = marked.parse(answerText);
            
            // æ·»åŠ åˆ°æ°”æ³¡
            bubble.appendChild(thinkingContainer);
            bubble.appendChild(answerContainer);
        } else {
            // æ²¡æœ‰æ¨ç†å†…å®¹ï¼Œæ­£å¸¸å¤„ç†
            bubble.innerHTML = marked.parse(decodedMarkdown.trim());
        }
    });
    
    // ä¿å­˜æ¨¡å‹é…ç½®
    async function saveModelConfigs() {
        const configs = [];
        const panelElements = modelPanelsContainer.querySelectorAll('.model-config-panel');
        const selectedModelIds = new Set();
        
        // å…ˆæ”¶é›†æ‰€æœ‰é€‰ä¸­çš„æ¨¡å‹IDï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é‡å¤
        let hasDuplicates = false;
        panelElements.forEach(panel => {
            const modelSelector = panel.querySelector('.model-selector');
            const selectedOption = modelSelector.options[modelSelector.selectedIndex];
            if (selectedOption && selectedOption.value && selectedOption.value !== 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹...') {
                const modelId = parseInt(selectedOption.value);
                if (selectedModelIds.has(modelId)) {
                    hasDuplicates = true;
                } else {
                    selectedModelIds.add(modelId);
                }
            }
        });
        
        // å¦‚æœæœ‰é‡å¤ï¼Œæ˜¾ç¤ºè­¦å‘Šå¹¶è¿”å›
        if (hasDuplicates) {
            window.showDaisyUIAlert('æç¤º', 'å­˜åœ¨é‡å¤é€‰æ‹©çš„æ¨¡å‹ï¼Œè¯·ç¡®ä¿æ¯ä¸ªé¢æ¿é€‰æ‹©ä¸åŒçš„æ¨¡å‹ã€‚');
            return;
        }
        
        // ç»§ç»­æ­£å¸¸ä¿å­˜é€»è¾‘
        panelElements.forEach(panel => {
            const modelSelector = panel.querySelector('.model-selector');
            const selectedOption = modelSelector.options[modelSelector.selectedIndex];
            if (selectedOption && selectedOption.value && selectedOption.value !== 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹...') {
                const systemPrompt = panel.querySelector('.system-prompt-input').value;
                const temperature = parseFloat(panel.querySelector('.temperature-slider').value);
                
                configs.push({
                    id: parseInt(selectedOption.value),
                    name: selectedOption.text.replace(/ \((ç³»ç»Ÿ|è‡ªå®šä¹‰)\)/, ''),
                    system_prompt: systemPrompt,
                    temperature: temperature
                });
            }
        });
        
        if (configs.length > 0) {
            try {
                // ä¿å­˜åˆ°æœåŠ¡å™¨
                const response = await fetch(`/chat/session/${sessionId}/save_configs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_configs: configs })
                });
                
                if (!response.ok) {
                    console.error('ä¿å­˜æ¨¡å‹é…ç½®åˆ°æœåŠ¡å™¨å¤±è´¥');
                } else {
                    // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ä»½
                    localStorage.setItem(`chat_model_config_${sessionId}`, JSON.stringify(configs));
                    console.log("é…ç½®å·²ä¿å­˜åˆ°æœåŠ¡å™¨å’Œæœ¬åœ°å­˜å‚¨");
                }
            } catch (error) {
                console.error('ä¿å­˜æ¨¡å‹é…ç½®æ—¶å‡ºé”™:', error);
                // å°è¯•åªä¿å­˜åˆ°æœ¬åœ°
                try {
                    localStorage.setItem(`chat_model_config_${sessionId}`, JSON.stringify(configs));
                    console.log("é…ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆæœåŠ¡å™¨ä¿å­˜å¤±è´¥ï¼‰");
                } catch (e) {
                    console.error("ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä¹Ÿå¤±è´¥:", e);
                }
            }
        }
    }
    
    // åŠ è½½ä¿å­˜çš„é…ç½® - ä»æœåŠ¡å™¨
    function loadSavedConfigs() {
        try {
            // è¿™é‡Œä½¿ç”¨Jinja2æ¸²æŸ“çš„å˜é‡ï¼Œä¼šåœ¨æœåŠ¡å™¨ç«¯å¤„ç†
            const savedConfigs = {{ saved_configs|tojson|safe }};
            
            if (!savedConfigs || !Array.isArray(savedConfigs) || savedConfigs.length === 0) {
                return false;
            }
            
            // æ¸…é™¤ç°æœ‰çš„é¢æ¿
            modelPanelsContainer.innerHTML = '';
            
            // ä¸ºæ¯ä¸ªä¿å­˜çš„é…ç½®åˆ›å»ºé¢æ¿
            savedConfigs.forEach((config, index) => {
                const panelId = Date.now() + index;
                const panelHTML = createModelPanelHTML(panelId);
                modelPanelsContainer.insertAdjacentHTML('beforeend', panelHTML);
                
                const panel = modelPanelsContainer.querySelector(`[data-panel-id="${panelId}"]`);
                
                // åˆå§‹åŒ–é¢æ¿äº‹ä»¶
                initPanelEventListeners(panel);
                
                // è®¾ç½®æ¨¡å‹é€‰æ‹©å™¨
                const selector = panel.querySelector('.model-selector');
                for (let i = 0; i < selector.options.length; i++) {
                    if (parseInt(selector.options[i].value) === config.id) {
                        selector.selectedIndex = i;
                        break;
                    }
                }
                
                // è®¾ç½®ç³»ç»Ÿæç¤ºå’Œæ¸©åº¦
                const promptInput = panel.querySelector('.system-prompt-input');
                const tempSlider = panel.querySelector('.temperature-slider');
                const tempDisplay = panel.querySelector('.temperature-value-display');
                
                if (config.system_prompt) {
                    promptInput.value = config.system_prompt;
                }
                
                if (config.temperature !== undefined) {
                    tempSlider.value = config.temperature;
                    tempDisplay.textContent = config.temperature;
                }
            });
            
            updateAddModelBtnState();
            console.log('å·²ä»æœåŠ¡å™¨æ¢å¤ä¿å­˜çš„æ¨¡å‹é…ç½®');
            return true;
        } catch (error) {
            console.error('ä»æœåŠ¡å™¨åŠ è½½æ¨¡å‹é…ç½®æ—¶å‡ºé”™:', error);
            return false;
        }
    }
    
    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½é…ç½®
    function loadSavedConfigFromLocalStorage() {
        try {
            const savedConfig = localStorage.getItem(`chat_model_config_${sessionId}`);
            if (!savedConfig) return false;
            
            const configs = JSON.parse(savedConfig);
            if (!Array.isArray(configs) || configs.length === 0) return false;
            
            // æ¸…é™¤ç°æœ‰çš„é¢æ¿
            modelPanelsContainer.innerHTML = '';
            
            // åˆ›å»ºæ–°é¢æ¿
            configs.forEach((config, index) => {
                // æ·»åŠ æ–°é¢æ¿
                const newPanelId = Date.now() + index;
                const panelHTML = createModelPanelHTML(newPanelId);
                modelPanelsContainer.insertAdjacentHTML('beforeend', panelHTML);
                
                const panel = modelPanelsContainer.querySelector(`[data-panel-id="${newPanelId}"]`);
                initPanelEventListeners(panel);
                
                // è®¾ç½®æ¨¡å‹é€‰æ‹©
                const selector = panel.querySelector('.model-selector');
                if (config.id) {
                    for (let i = 0; i < selector.options.length; i++) {
                        if (parseInt(selector.options[i].value) === config.id) {
                            selector.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                // è®¾ç½®ç³»ç»Ÿæç¤ºå’Œæ¸©åº¦
                const promptInput = panel.querySelector('.system-prompt-input');
                const tempSlider = panel.querySelector('.temperature-slider');
                const tempDisplay = panel.querySelector('.temperature-value-display');
                
                if (config.system_prompt) {
                    promptInput.value = config.system_prompt;
                }
                
                if (config.temperature) {
                    tempSlider.value = config.temperature;
                    tempDisplay.textContent = config.temperature;
                }
            });
            
            updateAddModelBtnState();
            console.log("å·²ä»æœ¬åœ°å­˜å‚¨æ¢å¤é…ç½®");
            return true;
        } catch (error) {
            console.error("ä»æœ¬åœ°å­˜å‚¨æ¢å¤é…ç½®æ—¶å‡ºé”™:", error);
            return false;
        }
    }
    
    // ç›‘å¬æ¨¡å‹é…ç½®çš„å˜æ›´
    function setupConfigChangeListeners() {
        const panels = modelPanelsContainer.querySelectorAll('.model-config-panel');
        panels.forEach(panel => {
            const modelSelector = panel.querySelector('.model-selector');
            const systemPrompt = panel.querySelector('.system-prompt-input');
            const tempSlider = panel.querySelector('.temperature-slider');
            
            modelSelector.addEventListener('change', saveModelConfigs);
            systemPrompt.addEventListener('blur', saveModelConfigs);
            tempSlider.addEventListener('change', saveModelConfigs);
        });
        
        // ç›‘å¬æ·»åŠ å’Œåˆ é™¤é¢æ¿
        addModelBtn.addEventListener('click', () => setTimeout(saveModelConfigs, 100));
        
        modelPanelsContainer.addEventListener('click', e => {
            if (e.target.closest('.remove-model-btn')) {
                setTimeout(saveModelConfigs, 100);
            }
        });
    }
    
    // ä»æœåŠ¡å™¨åŠ¨æ€åŠ è½½ä¿å­˜çš„é…ç½®
    async function loadSavedConfigsFromServer() {
        try {
            const response = await fetch(`/chat/session/${sessionId}/get_configs`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
                console.log('æœåŠ¡å™¨è·å–é…ç½®å¤±è´¥æˆ–é…ç½®ä¸å­˜åœ¨');
                return false;
            }
            
            const data = await response.json();
            const savedConfigs = data.model_configs;
            
            if (!savedConfigs || !Array.isArray(savedConfigs) || savedConfigs.length === 0) {
                console.log('æœåŠ¡å™¨è¿”å›ç©ºé…ç½®');
                return false;
            }
            
            // æ¸…é™¤ç°æœ‰çš„é¢æ¿
            modelPanelsContainer.innerHTML = '';
            
            // ä¸ºæ¯ä¸ªä¿å­˜çš„é…ç½®åˆ›å»ºé¢æ¿
            savedConfigs.forEach((config, index) => {
                const panelId = Date.now() + index;
                const panelHTML = createModelPanelHTML(panelId);
                modelPanelsContainer.insertAdjacentHTML('beforeend', panelHTML);
                
                const panel = modelPanelsContainer.querySelector(`[data-panel-id="${panelId}"]`);
                
                // åˆå§‹åŒ–é¢æ¿äº‹ä»¶
                initPanelEventListeners(panel);
                
                // è®¾ç½®æ¨¡å‹é€‰æ‹©å™¨
                const selector = panel.querySelector('.model-selector');
                for (let i = 0; i < selector.options.length; i++) {
                    if (parseInt(selector.options[i].value) === config.id) {
                        selector.selectedIndex = i;
                        break;
                    }
                }
                
                // è®¾ç½®ç³»ç»Ÿæç¤ºå’Œæ¸©åº¦
                const promptInput = panel.querySelector('.system-prompt-input');
                const tempSlider = panel.querySelector('.temperature-slider');
                const tempDisplay = panel.querySelector('.temperature-value-display');
                
                if (config.system_prompt) {
                    promptInput.value = config.system_prompt;
                }
                
                if (config.temperature !== undefined) {
                    tempSlider.value = config.temperature;
                    tempDisplay.textContent = config.temperature;
                }
            });
            
            updateAddModelBtnState();
            console.log('å·²ä»æœåŠ¡å™¨åŠ¨æ€åŠ è½½ä¿å­˜çš„æ¨¡å‹é…ç½®');
            return true;
        } catch (error) {
            console.error('åŠ¨æ€åŠ è½½æœåŠ¡å™¨é…ç½®æ—¶å‡ºé”™:', error);
            return false;
        }
    }

    // åˆå§‹åŒ–å‡½æ•° - ç»Ÿä¸€å¤„ç†é…ç½®åŠ è½½
    async function initializeModelPanels() {
        let configLoaded = false;
        
        // 1. é¦–å…ˆå°è¯•ä»æœåŠ¡å™¨åŠ¨æ€åŠ è½½é…ç½®
        configLoaded = await loadSavedConfigsFromServer();
        if (configLoaded) {
            console.log('å·²æˆåŠŸä»æœåŠ¡å™¨åŠ¨æ€åŠ è½½é…ç½®');
        } else {
            // 2. å¦‚æœåŠ¨æ€åŠ è½½å¤±è´¥ï¼Œå°è¯•ä»æ¨¡æ¿æ¸²æŸ“çš„æ•°æ®åŠ è½½
            configLoaded = loadSavedConfigs();
            if (configLoaded) {
                console.log('å·²æˆåŠŸä»æ¨¡æ¿æ•°æ®åŠ è½½é…ç½®');
            } else {
                // 3. å¦‚æœæ¨¡æ¿æ•°æ®ä¹Ÿæ²¡æœ‰ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                configLoaded = loadSavedConfigFromLocalStorage();
                if (configLoaded) {
                    console.log('å·²æˆåŠŸä»æœ¬åœ°å­˜å‚¨åŠ è½½é…ç½®');
                }
            }
        }
        
        // 4. å¦‚æœæ‰€æœ‰æ–¹å¼éƒ½æ²¡æœ‰é…ç½®ï¼Œåˆ›å»ºé»˜è®¤é¢æ¿
        if (!configLoaded) {
            console.log('æ²¡æœ‰æ‰¾åˆ°å·²ä¿å­˜çš„é…ç½®ï¼Œåˆ›å»ºé»˜è®¤é¢æ¿');
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰é»˜è®¤é¢æ¿
            const firstPanelInHtml = modelPanelsContainer.querySelector('.model-config-panel');
            if (firstPanelInHtml) {
                // å¦‚æœHTMLä¸­å·²æœ‰é»˜è®¤é¢æ¿ï¼Œåˆå§‹åŒ–å®ƒ
                initPanelEventListeners(firstPanelInHtml);
            } else {
                // åˆ›å»ºä¸€ä¸ªæ–°çš„é»˜è®¤é¢æ¿
                addNewModelPanel();
            }
        }
        
        // 5. è®¾ç½®é…ç½®å˜æ›´ç›‘å¬å™¨
        setupConfigChangeListeners();
        
        // 6. æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateAddModelBtnState();
    }
    
    // æ‰§è¡Œåˆå§‹åŒ–
    (async () => {
        await initializeModelPanels();
    })();

    // åˆ›å»ºæ–°çš„æ¨¡å‹é¢æ¿çš„HTML
    function createModelPanelHTML(panelId) {
        return `
        <div class="model-config-panel p-4 border rounded-lg shadow bg-base-100" data-panel-id="${panelId}">
            <div class="flex justify-between items-center mb-3">
                <select class="model-selector select select-bordered select-sm w-full max-w-xs" data-panel-id="${panelId}">
                    <option disabled selected>è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹...</option>
                    {% for model in available_models %}
                        <option value="{{ model.id }}"
                                data-sysprompt="{{ model.system_prompt | default('You are a helpful assistant.', true) | e }}"
                                data-temp="{{ model.default_temperature | default(0.7, true) }}">
                            {{ model.display_name }} {% if model.is_system_model %}(ç³»ç»Ÿ){% else %}(è‡ªå®šä¹‰){% endif %}
                        </option>
                    {% endfor %}
                </select>
                <div class="flex items-center space-x-1 ml-1 flex-shrink-0">
                    <button class="btn btn-xs btn-ghost toggle-config-btn" data-panel-id="${panelId}" aria-expanded="false">
                        <i class="fas fa-sliders-h"></i>
                    </button>
                    <button class="btn btn-xs btn-ghost text-error remove-model-btn" data-panel-id="${panelId}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="model-parameters p-3 border-t border-base-200" style="display: none;">
                <div class="form-control mb-3">
                    <label class="label">
                        <span class="label-text">System Prompt</span>
                    </label>
                    <textarea class="system-prompt-input textarea textarea-bordered textarea-sm h-20" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„åŠ©æ‰‹ã€‚"></textarea>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Temperature</span>
                        <span class="temperature-value-display text-sm">0.7</span>
                    </label>
                    <input type="range" min="0" max="1" step="0.1" value="0.7" class="temperature-slider range range-xs range-primary" />
                </div>
            </div>
        </div>
        `;
    }

    // æ·»åŠ æ–°çš„æ¨¡å‹é¢æ¿
    function addNewModelPanel() {
        const panelCount = modelPanelsContainer.querySelectorAll('.model-config-panel').length;
        if (panelCount >= MAX_MODELS) {
            window.showDaisyUIAlert('æç¤º', `æœ€å¤šåªèƒ½æ·»åŠ ${MAX_MODELS}ä¸ªæ¨¡å‹`);
            return;
        }
        
        const newPanelId = Date.now();
        const panelHTML = createModelPanelHTML(newPanelId);
        modelPanelsContainer.insertAdjacentHTML('beforeend', panelHTML);
        
        const newPanel = modelPanelsContainer.querySelector(`[data-panel-id="${newPanelId}"]`);
        initPanelEventListeners(newPanel);
        
        updateAddModelBtnState();
    }

    // æ›´æ–°æ·»åŠ æ¨¡å‹æŒ‰é’®çŠ¶æ€
    function updateAddModelBtnState() {
        const panelCount = modelPanelsContainer.querySelectorAll('.model-config-panel').length;
        addModelBtn.textContent = `æ·»åŠ æ¨¡å‹ (${panelCount}/${MAX_MODELS})`;
        
        if (panelCount >= MAX_MODELS) {
            addModelBtn.classList.add('btn-disabled');
        } else {
            addModelBtn.classList.remove('btn-disabled');
        }
        
        // å¤„ç†åˆ é™¤æŒ‰é’®çš„æ˜¾ç¤º/éšè—
        const removeBtns = modelPanelsContainer.querySelectorAll('.remove-model-btn');
        removeBtns.forEach(btn => {
            if (panelCount <= 1) {
                btn.style.display = 'none'; // åªæœ‰ä¸€ä¸ªé¢æ¿æ—¶éšè—åˆ é™¤æŒ‰é’®
            } else {
                btn.style.display = 'flex'; // å¤šä¸ªé¢æ¿æ—¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            }
        });
    }

    // ä¸ºæ·»åŠ æ¨¡å‹æŒ‰é’®ç»‘å®šäº‹ä»¶
    addModelBtn.addEventListener('click', addNewModelPanel);

    // æ–°å¯¹è¯æŒ‰é’®äº‹ä»¶å¤„ç†
    const newChatWithConfigBtn = document.getElementById('new-chat-with-config-btn');
    newChatWithConfigBtn.addEventListener('click', async function() {
        try {
            // è·å–å½“å‰çš„æ¨¡å‹é…ç½®
            const currentConfigs = [];
            const panelElements = modelPanelsContainer.querySelectorAll('.model-config-panel');
            
            panelElements.forEach(panel => {
                const modelSelector = panel.querySelector('.model-selector');
                const selectedOption = modelSelector.options[modelSelector.selectedIndex];
                if (selectedOption && selectedOption.value && selectedOption.value !== 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹...') {
                    const systemPrompt = panel.querySelector('.system-prompt-input').value;
                    const temperature = parseFloat(panel.querySelector('.temperature-slider').value);
                    
                    currentConfigs.push({
                        id: parseInt(selectedOption.value),
                        name: selectedOption.text.replace(/ \((ç³»ç»Ÿ|è‡ªå®šä¹‰)\)/, ''),
                        system_prompt: systemPrompt,
                        temperature: temperature
                    });
                }
            });
            
            if (currentConfigs.length === 0) {
                window.showDaisyUIAlert('æç¤º', 'è¯·å…ˆé…ç½®è‡³å°‘ä¸€ä¸ªæ¨¡å‹åå†å¼€å¯æ–°å¯¹è¯');
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            newChatWithConfigBtn.disabled = true;
            newChatWithConfigBtn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> åˆ›å»ºä¸­...';
            
            // åˆ›å»ºæ–°ä¼šè¯å¹¶ä¿å­˜é…ç½®
            const response = await fetch('/chat/new_with_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({
                    model_configs: currentConfigs
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                // è·³è½¬åˆ°æ–°çš„ä¼šè¯é¡µé¢
                window.location.href = `/chat/session/${data.session_id}`;
            } else {
                const errorData = await response.json();
                window.showDaisyUIAlert('é”™è¯¯', errorData.error || 'åˆ›å»ºæ–°å¯¹è¯å¤±è´¥');
            }
        } catch (error) {
            console.error('åˆ›å»ºæ–°å¯¹è¯æ—¶å‡ºé”™:', error);
            window.showDaisyUIAlert('é”™è¯¯', 'åˆ›å»ºæ–°å¯¹è¯æ—¶å‘ç”Ÿé”™è¯¯');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            newChatWithConfigBtn.disabled = false;
            newChatWithConfigBtn.innerHTML = '<i class="fas fa-plus mr-1"></i> æ–°å¯¹è¯';
        }
    });

    // åˆå§‹åŒ–é¢æ¿äº‹ä»¶ç›‘å¬å™¨
    function initPanelEventListeners(panelElement) {
        const panelId = panelElement.dataset.panelId;
        const modelSelectorElement = panelElement.querySelector('.model-selector');
        const toggleBtn = panelElement.querySelector('.toggle-config-btn');
        const paramsDiv = panelElement.querySelector('.model-parameters');
        const systemPromptInput = panelElement.querySelector('.system-prompt-input');
        const tempSlider = panelElement.querySelector('.temperature-slider');
        const tempValueDisplay = panelElement.querySelector('.temperature-value-display');
        const removeBtn = panelElement.querySelector('.remove-model-btn');

        modelSelectorElement.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value && selectedOption.value !== 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹...') {
                // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–é¢æ¿å·²ç»é€‰æ‹©äº†ç›¸åŒçš„æ¨¡å‹
                const otherSelectors = Array.from(document.querySelectorAll('.model-selector')).filter(sel => sel !== this);
                const isDuplicate = otherSelectors.some(sel => {
                    const otherOption = sel.options[sel.selectedIndex];
                    return otherOption && otherOption.value === selectedOption.value;
                });
                
                if (isDuplicate) {
                    window.showDaisyUIAlert('æç¤º', `è¯¥æ¨¡å‹å·²è¢«é€‰æ‹©ï¼Œè¯·é€‰æ‹©å…¶ä»–æ¨¡å‹ã€‚`);
                    // é‡ç½®ä¸ºé»˜è®¤é€‰é¡¹
                    this.selectedIndex = 0;
                    return;
                }
                
                systemPromptInput.value = selectedOption.dataset.sysprompt || '';
                const temp = selectedOption.dataset.temp || '0.7';
                tempSlider.value = temp;
                tempValueDisplay.textContent = temp;
                
                // ä¿å­˜é…ç½®
                saveModelConfigs();
            }
        });

        toggleBtn.addEventListener('click', () => {
            const isExpanded = paramsDiv.style.display === 'block';
            paramsDiv.style.display = isExpanded ? 'none' : 'block';
            toggleBtn.setAttribute('aria-expanded', String(!isExpanded));
        });

        tempSlider.addEventListener('input', () => {
            tempValueDisplay.textContent = tempSlider.value;
        });
        
        // ä¿å­˜æ¸©åº¦é…ç½®
        tempSlider.addEventListener('change', saveModelConfigs);
        
        // ä¿å­˜ç³»ç»Ÿæç¤º
        systemPromptInput.addEventListener('blur', saveModelConfigs);

        if(removeBtn) { // Ensure removeBtn exists, though it always should from template
            removeBtn.addEventListener('click', () => {
                if (modelPanelsContainer.querySelectorAll('.model-config-panel').length > 1) {
                    panelElement.remove();
                    updateAddModelBtnState();
                    
                    // ä¿å­˜é…ç½®
                    saveModelConfigs();
                }
            });
        }
    }

    function scrollToBottom() { messagesContainer.scrollTop = messagesContainer.scrollHeight; }
    scrollToBottom(); 

    // é”®ç›˜äº‹ä»¶å¤„ç† - å›è½¦å‘é€æ¶ˆæ¯
    messageInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    messageInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            chatForm.requestSubmit();
        }
    });

    // è¡¨å•æäº¤å¤„ç†
    chatForm.addEventListener('submit', async function (e) {
        e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡¨å•æäº¤è¡Œä¸ºï¼Œé¿å…é¡µé¢åˆ·æ–°
        const messageContent = messageInput.value.trim();
        
        const activeModelConfigs = [];
        const panelElements = modelPanelsContainer.querySelectorAll('.model-config-panel');
        let hasValidModelSelected = false;
        panelElements.forEach(panel => {
            const modelSelectorEl = panel.querySelector('.model-selector');
            const selectedOption = modelSelectorEl.options[modelSelectorEl.selectedIndex];
            if (selectedOption && selectedOption.value && selectedOption.value !== 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹...') {
                hasValidModelSelected = true;
                const systemPrompt = panel.querySelector('.system-prompt-input').value;
                const temperature = parseFloat(panel.querySelector('.temperature-slider').value);
                activeModelConfigs.push({
                    id: parseInt(selectedOption.value),
                    name: selectedOption.text.replace(/ \((ç³»ç»Ÿ|è‡ªå®šä¹‰)\)/, ''),
                    system_prompt: systemPrompt,
                    temperature: temperature
                });
            }
        });

        if (!messageContent || !hasValidModelSelected) {
            const alertMessage = !messageContent ? 'æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©ºï¼' : 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„AIæ¨¡å‹ï¼';
            window.showDaisyUIAlert('è¾“å…¥æç¤º', alertMessage);
            return;
        }

        messageInput.disabled = true;
        sendButton.classList.add('btn-disabled');
        sendButton.innerHTML = `<span class="loading loading-spinner loading-xs"></span>å‘é€ä¸­...`;
        if(emptyChatPlaceholder) emptyChatPlaceholder.style.display = 'none';

        addMessageToUI('user', messageContent, new Date().toISOString(), null);
        messageInput.value = '';
        messageInput.style.height = 'auto'; 
        scrollToBottom();

        // ä¸ºæ¯ä¸ªæ¨¡å‹åˆ›å»ºä¸€ä¸ªå“åº”å®¹å™¨å’Œæ‰“å­—æŒ‡ç¤ºå™¨
        const modelResponseElements = {};
        activeModelConfigs.forEach(modelConfig => {
            const modelId = modelConfig.id;
            const modelName = modelConfig.name;
            
            // åˆ›å»ºæ¨¡å‹å“åº”å®¹å™¨
            const modelResponseDiv = document.createElement('div');
            modelResponseDiv.classList.add('chat-message', 'chat', 'chat-start');
            modelResponseDiv.dataset.modelId = modelId;
            
            // åˆ›å»ºæ¨¡å‹æ ‡é¢˜ - ä¸åŸæœ‰æ ¼å¼ä¸€è‡´
            const modelHeader = document.createElement('div');
            modelHeader.classList.add('chat-header', 'pb-1');
            
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            modelHeader.textContent = `Assistant ${currentTime} (${modelName})`;
            
            modelResponseDiv.appendChild(modelHeader);
            
            // åˆ›å»ºæ¨¡å‹å“åº”æ°”æ³¡
            const modelBubble = document.createElement('div');
            modelBubble.classList.add('chat-bubble', 'chat-bubble-accent');
            
            // åˆ›å»ºæ‰“å­—æŒ‡ç¤ºå™¨
            const typingIndicatorDiv = document.createElement('div');
            typingIndicatorDiv.classList.add('typing-indicator');
            typingIndicatorDiv.innerHTML = '<span></span><span></span><span></span>';
            modelBubble.appendChild(typingIndicatorDiv);
            
            modelResponseDiv.appendChild(modelBubble);
            
            // ç›´æ¥æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨
            messagesContainer.appendChild(modelResponseDiv);
            
            // ä¿å­˜å…ƒç´ å¼•ç”¨
            modelResponseElements[modelId] = {
                container: modelResponseDiv,
                header: modelHeader,
                bubble: modelBubble,
                typingIndicator: typingIndicatorDiv,
                rawMarkdown: ''
            };
        });
        
        scrollToBottom();

        const requestBody = { message: messageContent, models: activeModelConfigs };
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'text/event-stream',
            'X-CSRFToken': csrfToken
        };
        
        try {
            const response = await fetch(`/chat/session/${sessionId}/send`, {
                method: 'POST', headers: headers, body: JSON.stringify(requestBody)
            });

            if (!response.ok || !response.body) {
                for (const modelId in modelResponseElements) {
                    const elements = modelResponseElements[modelId];
                    if (elements.typingIndicator) {
                        elements.typingIndicator.remove();
                    }
                    elements.bubble.classList.remove('chat-bubble-accent');
                    elements.bubble.classList.add('chat-bubble-info');
                    elements.bubble.innerHTML = `<span>è¯·æ±‚å¤±è´¥: ${response.status}</span>`;
                }
                resetInputControls();
                scrollToBottom();
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                let eolIndex;
                while ((eolIndex = buffer.indexOf('\n\n')) >= 0) {
                    const line = buffer.substring(0, eolIndex).trim();
                    buffer = buffer.substring(eolIndex + 2);
                    
                    if (line.startsWith('data:')) {
                        const jsonData = line.substring(5).trim();
                        try {
                            const eventData = JSON.parse(jsonData);
                            
                            // æ£€æŸ¥æ˜¯å¦æ”¶åˆ°æ‰€æœ‰æ¨¡å‹å®Œæˆçš„äº‹ä»¶
                            if (eventData.all_models_completed) {
                                console.log('æ‰€æœ‰æ¨¡å‹å“åº”å·²å®Œæˆ');
                                continue;
                            }
                            
                            // è·å–å½“å‰äº‹ä»¶æ‰€å±çš„æ¨¡å‹ID
                            const modelId = eventData.model_id;
                            if (!modelId || !modelResponseElements[modelId]) {
                                console.error('æ”¶åˆ°æœªçŸ¥æ¨¡å‹çš„å“åº”:', eventData);
                                continue;
                            }
                            
                            const elements = modelResponseElements[modelId];
                            
                            // å¤„ç†é”™è¯¯äº‹ä»¶
                            if (eventData.error) {
                                if (elements.typingIndicator) {
                                    elements.typingIndicator.remove();
                                }
                                elements.bubble.classList.remove('chat-bubble-accent');
                                elements.bubble.classList.add('chat-bubble-info');
                                elements.bubble.innerHTML = `<span>é”™è¯¯: ${eventData.details || eventData.error}</span>`;
                                console.error(`æ¨¡å‹ ${eventData.model_name} (${modelId}) å‘ç”Ÿé”™è¯¯:`, eventData);
                                continue;
                            }
                            
                            // å¤„ç†å†…å®¹ç‰‡æ®µ
                            if (eventData.content_piece !== undefined) {
                                // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
                                if (elements.typingIndicator && elements.typingIndicator.parentNode) {
                                    elements.typingIndicator.remove();
                                    elements.typingIndicator = null;
                                }
                                
                                // è¿½åŠ å†…å®¹
                                elements.rawMarkdown += eventData.content_piece;
                                
                                // è®°å½•æ¥æ”¶åˆ°çš„å†…å®¹ç‰‡æ®µ
                                console.debug(`æ”¶åˆ°æ¨¡å‹ ${eventData.model_name} çš„å†…å®¹: "${eventData.content_piece}"`);
                                
                                // å¦‚æœå·²ç»æœ‰æ€è€ƒè¿‡ç¨‹å®¹å™¨ï¼Œåªæ›´æ–°ç­”æ¡ˆéƒ¨åˆ†
                                if (elements.thinkingContainer) {
                                    // ç¡®ä¿æœ‰ç­”æ¡ˆå®¹å™¨
                                    if (!elements.answerContainer) {
                                        elements.answerContainer = document.createElement('div');
                                        elements.answerContainer.classList.add('answer-content');
                                        elements.bubble.appendChild(elements.answerContainer);
                                    }
                                    
                                    // è§£æå¹¶æ¸²æŸ“ç­”æ¡ˆå†…å®¹
                                    let markdownToParse = elements.rawMarkdown;
                                    const mdBlockRegex = /^```markdown\s*\n([\s\S]*?)\s*\n```$/;
                                    const match = markdownToParse.match(mdBlockRegex);
                                    if (match && match[1]) markdownToParse = match[1];
                                    
                                    elements.answerContainer.innerHTML = marked.parse(markdownToParse);
                                    scrollToBottom();
                                } else {
                                    // æ²¡æœ‰æ€è€ƒè¿‡ç¨‹å®¹å™¨ï¼Œæ­£å¸¸æ¸²æŸ“
                                    let markdownToParse = elements.rawMarkdown;
                                    const mdBlockRegex = /^```markdown\s*\n([\s\S]*?)\s*\n```$/;
                                    const match = markdownToParse.match(mdBlockRegex);
                                    if (match && match[1]) markdownToParse = match[1];
                                    
                                    // ä½¿ç”¨requestAnimationFrameç¡®ä¿UIæ›´æ–°ä¸è¢«é˜»å¡
                                    requestAnimationFrame(() => {
                                        elements.bubble.innerHTML = marked.parse(markdownToParse);
                                        scrollToBottom();
                                    });
                                }
                            }
                            
                            // å¤„ç†æ¨ç†å†…å®¹ç‰‡æ®µ
                            if (eventData.reasoning_piece !== undefined) {
                                // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
                                if (elements.typingIndicator && elements.typingIndicator.parentNode) {
                                    elements.typingIndicator.remove();
                                    elements.typingIndicator = null;
                                }
                                
                                // åˆå§‹åŒ–æ¨ç†å®¹å™¨
                                if (!elements.thinkingContainer) {
                                    const thinkingContainer = document.createElement('div');
                                    thinkingContainer.classList.add('thinking-container');
                                    
                                    const thinkingHeader = document.createElement('div');
                                    thinkingHeader.classList.add('thinking-header', 'thinking-toggle');
                                    thinkingHeader.innerHTML = '<i class="fas fa-brain mr-2"></i>ğŸ’­ æ€è€ƒè¿‡ç¨‹ <i class="fas fa-chevron-up ml-auto"></i>';
                                    
                                    const thinkingContent = document.createElement('div');
                                    thinkingContent.classList.add('thinking-content');
                                    
                                    thinkingContainer.appendChild(thinkingHeader);
                                    thinkingContainer.appendChild(thinkingContent);
                                    
                                    // æ·»åŠ ç‚¹å‡»æŠ˜å åŠŸèƒ½
                                    thinkingHeader.addEventListener('click', () => {
                                        const isCollapsed = thinkingContent.classList.contains('collapsed');
                                        // æ›´å¥å£®çš„å›¾æ ‡æŸ¥æ‰¾ï¼šæŸ¥æ‰¾æœ€åä¸€ä¸ª i å…ƒç´ ï¼ˆchevronå›¾æ ‡ï¼‰
                                        const chevron = thinkingHeader.querySelector('i:last-child');
                                        if (isCollapsed) {
                                            thinkingContent.classList.remove('collapsed');
                                            chevron.className = 'fas fa-chevron-up ml-auto';
                                        } else {
                                            thinkingContent.classList.add('collapsed');
                                            chevron.className = 'fas fa-chevron-down ml-auto';
                                        }
                                    });
                                    
                                    elements.bubble.appendChild(thinkingContainer);
                                    elements.thinkingContainer = thinkingContainer;
                                    elements.thinkingContent = thinkingContent;
                                    elements.reasoningText = '';
                                }
                                
                                // è¿½åŠ æ¨ç†å†…å®¹
                                elements.reasoningText += eventData.reasoning_piece;
                                elements.thinkingContent.textContent = elements.reasoningText;
                                
                                console.debug(`æ”¶åˆ°æ¨¡å‹ ${eventData.model_name} çš„æ¨ç†å†…å®¹: "${eventData.reasoning_piece}"`);
                                scrollToBottom();
                            }
                            
                            // å¤„ç†æœ€ç»ˆå—
                            if (eventData.is_final_chunk) {
                                console.log(`æ¨¡å‹ ${eventData.model_name} (${modelId}) å“åº”å®Œæˆ`);
                                
                                // å¦‚æœä»æœ‰æ‰“å­—æŒ‡ç¤ºå™¨ï¼Œç§»é™¤å®ƒ
                                if (elements.typingIndicator && elements.typingIndicator.parentNode) {
                                    elements.typingIndicator.remove();
                                    elements.typingIndicator = null;
                                }
                                
                                // ç¡®ä¿æœ€ç»ˆå†…å®¹å·²è¢«æ­£ç¡®æ¸²æŸ“
                                if (eventData.full_content) {
                                    elements.rawMarkdown = eventData.full_content;
                                    
                                    // è§£ç HTMLå®ä½“
                                    function decodeHtmlEntities(text) {
                                        const textarea = document.createElement('textarea');
                                        textarea.innerHTML = text;
                                        return textarea.value;
                                    }
                                    
                                    const decodedContent = decodeHtmlEntities(elements.rawMarkdown);
                                    
                                    // æ£€æŸ¥æ˜¯å¦åŒ…å«æ¨ç†æ ¼å¼ <think>xxx</think><answer>xxx</answer>
                                    // å¤„ç†å¯èƒ½çš„åŒé‡thinkæ ‡ç­¾: <think><think>content</think>
                                    let thinkAnswerRegex = /<think.*?>([\s\S]*?)<\/think><answer>([\s\S]*?)<\/answer>/;
                                    let match = decodedContent.match(thinkAnswerRegex);
                                    
                                    // å¦‚æœç¬¬ä¸€ä¸ªæ­£åˆ™ä¸åŒ¹é…ï¼Œå°è¯•ç¬¬äºŒä¸ª
                                    if (!match) {
                                        thinkAnswerRegex = /<think>([\s\S]*?)<\/think><answer>([\s\S]*?)<\/answer>/;
                                        match = decodedContent.match(thinkAnswerRegex);
                                    }
                                    
                                    console.log('æœ€ç»ˆå—æ¨ç†å†…å®¹åŒ¹é…ç»“æœ:', match);
                                    
                                    if (match && match[1] && match[2]) {
                                        // æœ‰æ¨ç†å†…å®¹
                                        const thinkingText = match[1].trim();
                                        const answerText = match[2].trim();
                                        
                                        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ€è€ƒè¿‡ç¨‹å®¹å™¨ï¼ˆæµå¼åˆ›å»ºçš„ï¼‰
                                        if (elements.thinkingContainer) {
                                            // æ›´æ–°å·²æœ‰çš„æ€è€ƒå†…å®¹
                                            elements.thinkingContent.textContent = thinkingText;
                                            
                                            // æ›´æ–°æˆ–åˆ›å»ºç­”æ¡ˆå®¹å™¨
                                            if (elements.answerContainer) {
                                                elements.answerContainer.innerHTML = marked.parse(answerText);
                                            } else {
                                                const answerContainer = document.createElement('div');
                                                answerContainer.classList.add('answer-content');
                                                answerContainer.innerHTML = marked.parse(answerText);
                                                elements.bubble.appendChild(answerContainer);
                                                elements.answerContainer = answerContainer;
                                            }
                                        } else {
                                            // æ²¡æœ‰æµå¼æ€è€ƒå®¹å™¨ï¼Œåˆ›å»ºå®Œæ•´å¸ƒå±€
                                            elements.bubble.innerHTML = '';
                                            
                                            // åˆ›å»ºæ€è€ƒè¿‡ç¨‹å®¹å™¨
                                            const thinkingContainer = document.createElement('div');
                                            thinkingContainer.classList.add('thinking-container');
                                            
                                            const thinkingHeader = document.createElement('div');
                                            thinkingHeader.classList.add('thinking-header', 'thinking-toggle');
                                            thinkingHeader.innerHTML = '<i class="fas fa-brain mr-2"></i>ğŸ’­ æ€è€ƒè¿‡ç¨‹ <i class="fas fa-chevron-up ml-auto"></i>';
                                            
                                            const thinkingContent = document.createElement('div');
                                            thinkingContent.classList.add('thinking-content');
                                            thinkingContent.textContent = thinkingText;
                                            
                                            thinkingContainer.appendChild(thinkingHeader);
                                            thinkingContainer.appendChild(thinkingContent);
                                            
                                            // æ·»åŠ ç‚¹å‡»æŠ˜å åŠŸèƒ½
                                            thinkingHeader.addEventListener('click', () => {
                                                const isCollapsed = thinkingContent.classList.contains('collapsed');
                                                // æ›´å¥å£®çš„å›¾æ ‡æŸ¥æ‰¾ï¼šæŸ¥æ‰¾æœ€åä¸€ä¸ª i å…ƒç´ ï¼ˆchevronå›¾æ ‡ï¼‰
                                                const chevron = thinkingHeader.querySelector('i:last-child');
                                                if (isCollapsed) {
                                                    thinkingContent.classList.remove('collapsed');
                                                    chevron.className = 'fas fa-chevron-up ml-auto';
                                                } else {
                                                    thinkingContent.classList.add('collapsed');
                                                    chevron.className = 'fas fa-chevron-down ml-auto';
                                                }
                                            });
                                            
                                            // åˆ›å»ºç­”æ¡ˆå®¹å™¨
                                            const answerContainer = document.createElement('div');
                                            answerContainer.classList.add('answer-content');
                                            answerContainer.innerHTML = marked.parse(answerText);
                                            
                                            // æ·»åŠ åˆ°æ°”æ³¡
                                            elements.bubble.appendChild(thinkingContainer);
                                            elements.bubble.appendChild(answerContainer);
                                        }
                                    } else {
                                        // æ²¡æœ‰æ¨ç†å†…å®¹ï¼Œæ­£å¸¸å¤„ç†
                                        let markdownToParse = elements.rawMarkdown;
                                        const mdBlockRegex = /^```markdown\s*\n([\s\S]*?)\s*\n```$/;
                                        const mdMatch = markdownToParse.match(mdBlockRegex);
                                        if (mdMatch && mdMatch[1]) markdownToParse = mdMatch[1];
                                        
                                        elements.bubble.innerHTML = marked.parse(markdownToParse);
                                    }
                                    
                                    scrollToBottom();
                                }
                            }
                        } catch (e) {
                            console.error('è§£æSSEäº‹ä»¶æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', e, jsonData);
                            for (const modelId in modelResponseElements) {
                                const elements = modelResponseElements[modelId];
                                if (elements.typingIndicator && elements.typingIndicator.parentNode) {
                                    elements.typingIndicator.remove();
                                }
                                elements.bubble.classList.remove('chat-bubble-accent');
                                elements.bubble.classList.add('chat-bubble-info');
                                if (!elements.bubble.innerHTML || elements.bubble.innerHTML.includes('typing-indicator')) {
                                    elements.bubble.innerHTML = '<span>è§£æå“åº”æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯</span>';
                                }
                            }
                        }
                    }
                }
            }
        } catch (error) {
            console.error('æµè·å–é”™è¯¯:', error);
            for (const modelId in modelResponseElements) {
                const elements = modelResponseElements[modelId];
                if (elements.typingIndicator && elements.typingIndicator.parentNode) {
                    elements.typingIndicator.remove();
                }
                elements.bubble.classList.remove('chat-bubble-accent');
                elements.bubble.classList.add('chat-bubble-info');
                elements.bubble.innerHTML = `<span>ä¸»è¦è¯·æ±‚é”™è¯¯: ${error.message}</span>`;
            }
        } finally {
            resetInputControls();
            scrollToBottom();
        }
    });

    function resetInputControls() {
        messageInput.disabled = false;
        sendButton.classList.remove('btn-disabled');
        sendButton.innerHTML = `<i class="fas fa-paper-plane"></i><span class="ml-2">å‘é€</span>`;
        typingIndicatorContainer.style.display = 'none';
    }

    // Modified addMessageToUI for general use, multi-model display will require more.
    function addMessageToUI(role, content, timestamp, settings, shouldScroll = true, messageElementId = null) {
        const messageDiv = document.createElement('div');
        if (messageElementId) messageDiv.id = messageElementId;
        messageDiv.classList.add('chat-message', 'chat', role === 'user' ? 'chat-end' : 'chat-start');
        
        const header = document.createElement('div');
        header.classList.add('chat-header', 'pb-1');
        header.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        const time = document.createElement('time');
        time.classList.add('text-xs', 'opacity-50', 'ml-1');
        time.textContent = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        header.appendChild(time);

        if (role === 'assistant' && settings && (settings.model_identifier || settings.model_id) ) {
            const modelNameSpan = document.createElement('span');
            modelNameSpan.classList.add('text-xs', 'opacity-60', 'ml-1');
            let modelDisplayName = settings.model_identifier; // Prefer identifier from settings if available
            if (!modelDisplayName && settings.model_id) { // Fallback to trying to find from a global selector (less ideal now)
                 const anyModelSelector = document.querySelector('.model-selector'); // Generic selector, might not be the one being configured
                 if (anyModelSelector) {
                    const optionElement = anyModelSelector.querySelector(`option[value="${settings.model_id}"]`);
                    if (optionElement) modelDisplayName = optionElement.text.replace(/ \((ç³»ç»Ÿ|è‡ªå®šä¹‰)\)/, '');
                 }
            }
            modelNameSpan.textContent = ` (${modelDisplayName || 'æ¨¡å‹'})`;
            header.appendChild(modelNameSpan);
        }
        
        const bubble = document.createElement('div');
        bubble.classList.add('chat-bubble');
        if (role === 'user') bubble.classList.add('chat-bubble-primary');
        else if (role === 'assistant') bubble.classList.add('chat-bubble-accent');
        else if (role === 'system') bubble.classList.add('chat-bubble-info'); 
        else bubble.classList.add('chat-bubble-info'); // Default for other roles
        
        // Content setting needs to be careful: if it's pre-rendered markdown, fine.
        // If it's raw text for user/system, also fine.
        // For assistant messages handled by streaming markdown, this might be an empty initial set.
        if (role === 'assistant' && content === '') { // Empty initial content for streaming markdown from assistant
            bubble.innerHTML = '';
        } else if (typeof content === 'string') {
             // For history messages (already parsed markdown) or user/system messages (plain text)
             // If content for historical assistant messages is raw markdown, it's handled by the DOMContentLoaded loop
            bubble.innerHTML = content.replace(/\n/g, '<br>'); // Basic newline handling for non-markdown text
        }
        
        messageDiv.appendChild(header);
        messageDiv.appendChild(bubble);

        messagesContainer.appendChild(messageDiv);

        if (shouldScroll) scrollToBottom();
        return messageDiv;
    }

    // å¤„ç†å†å²æ¶ˆæ¯ä¸­çš„Markdown
    const historicalAssistantBubbles = messagesContainer.querySelectorAll('.chat-message.chat-start .chat-bubble-accent');
    historicalAssistantBubbles.forEach(bubble => {
        let rawMarkdown = bubble.innerHTML;
        rawMarkdown = rawMarkdown.replace(/<br\s*\/?>/g, "\n"); 
        const mdBlockRegex = /^```markdown\s*\n([\s\S]*?)\s*\n```$/;
        const match = rawMarkdown.match(mdBlockRegex);
        if (match && match[1]) {
            rawMarkdown = match[1];
            bubble.innerHTML = marked.parse(rawMarkdown);
        }
    });
});
</script>
{% endblock %} 